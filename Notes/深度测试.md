# 传统Z-Test
依次绘制，更新深度信息，再决定像素是否覆盖更新,即为深度测试
![](https://pic3.zhimg.com/80/v2-3158c38dda0c9e369343147d06b41a6e_720w.webp)


# EarlyZ
允许深度测试在片段着色器之前运行,但是最后的深度测试仍然需要进行保证最终的遮挡关系正确

	为什么可以EarlyZ
	每个片元的深度信息在光栅化之后就已经知道了，因此使用Early-Z技术，在进入片元着色器之前就可以提前舍弃掉那些被不透明片元遮挡的片元，优化渲染效率

# Early-Z失效
- **Alpha Test 或 clip/discard等手动丢弃片元操作**
	Early-Z不仅会进行深度测试，还要进行深度写入，如果Alpha Test开启，后续像素无法正常渲染
- **Alpha Blend**
	开启了透明度混合不会开启深度写入，也就不能Early-Z
	从近往远渲染的话，Early-Z能发挥最大的性能优化,如果需要渲染不透明物体，从远到近的渲染顺序将让EarlyZ毫无意义
- **开启Multi-Sampling**
	多采样会影响周边像素，而Early-Z阶段无法得知周边像素是否被裁剪，故无法提前剔除。


# Z-Prepass（Pre-Z）
- pass1：Z-prepass中**仅仅写入深度**，不计算输出任何颜色。目的只是为了深度值写入缓冲区
- pass2：关闭深度写入，将深度比较函数改为相等，进行正常的透明度混合（AlphaBlend）


# z-fighting

z-buffer结果值精确度不够，靠的很近的物体，相机转换不同角度时，会发生像素的“争斗”
几个物体之间的片段值有的时候a通过，有的时候b通过，导致交替显示这几个物体的颜色值，然后就会产生闪烁的现象

![](https://pic4.zhimg.com/80/v2-41df59abca1a8a93d74761fda1ff5533_720w.webp)

## 为什么会有Z-fighting
**透视除法导致深度值的精度不足**
	深度缓冲区存储的深度值，是ndc空间中的深度值。而ndc空间的深度值经由透视空间转换过来的，ndc空间的深度值与透视空间的深度值转换需要经过透视除法，这是一个非线性的变换，导致视点越近的物体的片段深度值是越精确的，离视点距离约远的物体的片段的深度值是约不精确的
	正交透视矩阵渲染场景，其变换是线性的，不需要透视除法，也就没有z-fighting
## 避免Z-Fighting
- 适当的减小近平面与远平面的绝对距离
- 翻转深度，让近处的精度精确而远程的精度降低，在远处出现z-fighting我们也不太会注意得到
- 提高深度缓存的精度